<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="theme-color" content="#0f1117">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Money Log">
<title>Money Log</title>
<link rel="manifest" href="#" id="manifest-link">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #0a0c12;
    --bg2: #111520;
    --bg3: #1a1f2e;
    --bg4: #222840;
    --border: #2a3050;
    --text: #e8eaf6;
    --text2: #8892b0;
    --text3: #4a5580;
    --accent: #6ee7b7;
    --accent2: #38bdf8;
    --accent3: #f472b6;
    --accent4: #fb923c;
    --red: #f87171;
    --green: #4ade80;
    --yellow: #fbbf24;
    --purple: #a78bfa;
    --card-r: 16px;
    --font: 'Sarabun', sans-serif;
    --mono: 'Space Mono', monospace;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  body { font-family: var(--font); background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }
  body.no-scroll { overflow: hidden; }
  
  /* Layout */
  #app { display: flex; flex-direction: column; min-height: 100vh; }
  .topbar { 
    position: sticky; top: 0; z-index: 100;
    background: rgba(10,12,18,0.9); backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    padding: 0 16px;
    display: flex; align-items: center; justify-content: space-between;
    height: 56px;
  }
  .topbar-title { font-family: var(--mono); font-size: 1rem; font-weight: 700; color: var(--accent); letter-spacing: -0.5px; }
  .topbar-actions { display: flex; gap: 8px; }
  
  .main-content { flex: 1; padding: 16px; padding-bottom: 80px; max-width: 600px; margin: 0 auto; width: 100%; }
  
  .bottom-nav {
    position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
    background: rgba(10,12,18,0.95); backdrop-filter: blur(20px);
    border-top: 1px solid var(--border);
    display: flex; align-items: stretch;
    height: 64px;
    max-width: 600px; margin: 0 auto;
  }
  .nav-item {
    flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 2px; cursor: pointer; border: none; background: none; color: var(--text3);
    font-family: var(--font); font-size: 0.65rem; font-weight: 500;
    transition: color 0.2s; padding: 4px 0;
  }
  .nav-item.active { color: var(--accent); }
  .nav-item svg { width: 22px; height: 22px; }
  
  /* Cards */
  .card { background: var(--bg2); border: 1px solid var(--border); border-radius: var(--card-r); padding: 16px; }
  .card + .card { margin-top: 12px; }
  .card-title { font-size: 0.75rem; font-weight: 600; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
  
  /* Buttons */
  .btn { border: none; border-radius: 10px; cursor: pointer; font-family: var(--font); font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
  .btn-primary { background: var(--accent); color: #0a0c12; padding: 12px 20px; font-size: 0.9rem; width: 100%; }
  .btn-primary:active { transform: scale(0.98); opacity: 0.9; }
  .btn-sm { padding: 6px 12px; font-size: 0.8rem; background: var(--bg3); color: var(--text); border: 1px solid var(--border); }
  .btn-icon { width: 36px; height: 36px; border-radius: 10px; background: var(--bg3); color: var(--text2); border: 1px solid var(--border); padding: 0; }
  .btn-danger { background: rgba(248,113,113,0.15); color: var(--red); border: 1px solid rgba(248,113,113,0.3); }
  .btn-fab {
    position: fixed; bottom: 80px; right: 16px; z-index: 90;
    width: 52px; height: 52px; border-radius: 16px;
    background: var(--accent); color: #0a0c12;
    border: none; cursor: pointer; font-size: 1.5rem; font-weight: 300;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 24px rgba(110,231,183,0.35);
    transition: all 0.2s;
  }
  .btn-fab:active { transform: scale(0.95); }
  
  /* Forms */
  .form-group { margin-bottom: 14px; }
  .form-label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--text2); margin-bottom: 6px; }
  .form-input {
    width: 100%; padding: 11px 14px; border-radius: 10px;
    background: var(--bg3); border: 1px solid var(--border); color: var(--text);
    font-family: var(--font); font-size: 0.95rem; outline: none;
    transition: border-color 0.2s;
  }
  .form-input:focus { border-color: var(--accent); }
  .form-input::placeholder { color: var(--text3); }
  select.form-input { cursor: pointer; }
  
  /* Modal */
  .modal-overlay {
    position: fixed; inset: 0; z-index: 200;
    background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
    display: flex; align-items: flex-end; justify-content: center;
    opacity: 0; pointer-events: none; transition: opacity 0.25s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal {
    background: var(--bg2); border: 1px solid var(--border);
    border-radius: 20px 20px 0 0; padding: 20px;
    width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto;
    transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
  }
  .modal-overlay.open .modal { transform: translateY(0); }
  .modal-handle { width: 36px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 16px; }
  .modal-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 16px; }
  .modal-footer { display: flex; gap: 10px; margin-top: 16px; }
  .modal-footer .btn { flex: 1; padding: 12px; }

  /* Tabs */
  .tabs { display: flex; gap: 4px; background: var(--bg3); border-radius: 12px; padding: 4px; margin-bottom: 16px; }
  .tab { flex: 1; padding: 8px; border: none; border-radius: 8px; background: none; color: var(--text2); font-family: var(--font); font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
  .tab.active { background: var(--bg4); color: var(--accent); }

  /* Transaction item */
  .tx-item {
    display: flex; align-items: center; gap: 12px; padding: 12px 0;
    border-bottom: 1px solid var(--border);
  }
  .tx-item:last-child { border-bottom: none; }
  .tx-icon { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
  .tx-info { flex: 1; min-width: 0; }
  .tx-name { font-size: 0.9rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .tx-meta { font-size: 0.75rem; color: var(--text2); margin-top: 2px; }
  .tx-amount { font-family: var(--mono); font-size: 0.95rem; font-weight: 700; white-space: nowrap; }
  .tx-amount.expense { color: var(--red); }
  .tx-amount.income { color: var(--green); }
  
  /* Payment badges */
  .badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; }
  .badge-cash { background: rgba(251,191,36,0.15); color: var(--yellow); }
  .badge-bank { background: rgba(56,189,248,0.15); color: var(--accent2); }
  .badge-credit { background: rgba(244,114,182,0.15); color: var(--accent3); }

  /* Summary cards */
  .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
  .summary-card { background: var(--bg3); border: 1px solid var(--border); border-radius: 12px; padding: 14px; }
  .summary-card.full { grid-column: 1/-1; }
  .summary-label { font-size: 0.7rem; font-weight: 600; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; }
  .summary-value { font-family: var(--mono); font-size: 1.2rem; font-weight: 700; margin-top: 4px; }
  .summary-value.income { color: var(--green); }
  .summary-value.expense { color: var(--red); }
  .summary-value.neutral { color: var(--accent); }

  /* Payment method rows */
  .method-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); }
  .method-row:last-child { border-bottom: none; }
  .method-left { display: flex; align-items: center; gap: 10px; }
  .method-icon { width: 32px; height: 32px; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
  .method-name { font-size: 0.9rem; font-weight: 600; }
  .method-sub { font-size: 0.72rem; color: var(--text2); }
  .method-amount { font-family: var(--mono); font-weight: 700; font-size: 0.95rem; }

  /* Category row */
  .cat-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); }
  .cat-row:last-child { border-bottom: none; }
  .cat-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
  .cat-bar-wrap { flex: 1; }
  .cat-bar-label { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 4px; }
  .cat-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
  .cat-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s; }

  /* Date picker area */
  .date-nav { display: flex; align-items: center; gap: 8px; }
  .date-nav input { background: var(--bg3); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-family: var(--font); padding: 7px 12px; font-size: 0.85rem; cursor: pointer; outline: none; }
  .date-nav input:focus { border-color: var(--accent); }

  /* Settings list */
  .settings-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 0; border-bottom: 1px solid var(--border); cursor: pointer; }
  .settings-item:last-child { border-bottom: none; }
  .settings-item-left { display: flex; align-items: center; gap: 12px; }
  .settings-item-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
  .settings-item-title { font-weight: 600; font-size: 0.9rem; }
  .settings-item-sub { font-size: 0.75rem; color: var(--text2); margin-top: 1px; }

  /* Color picker */
  .color-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; }
  .color-swatch { width: 100%; aspect-ratio: 1; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.15s; }
  .color-swatch.selected { border-color: white; transform: scale(0.85); }

  /* Emoji picker */
  .emoji-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 4px; }
  .emoji-btn { padding: 6px; border-radius: 8px; border: 1px solid transparent; background: none; font-size: 1.2rem; cursor: pointer; transition: all 0.15s; }
  .emoji-btn:hover, .emoji-btn.selected { background: var(--bg3); border-color: var(--accent); }

  /* Chart container */
  .chart-wrap { position: relative; height: 200px; margin-top: 8px; }
  .chart-wrap.pie { height: 220px; }

  /* Chip selector */
  .chips { display: flex; flex-wrap: wrap; gap: 6px; }
  .chip { padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border); background: var(--bg3); color: var(--text2); font-family: var(--font); font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
  .chip.selected { background: var(--accent); color: #0a0c12; border-color: var(--accent); }

  /* Amount input special */
  .amount-input { font-family: var(--mono); font-size: 1.8rem; font-weight: 700; color: var(--accent); text-align: right; }
  
  /* Toast */
  .toast { position: fixed; top: 70px; left: 50%; transform: translateX(-50%) translateY(-20px); z-index: 999; background: var(--bg4); border: 1px solid var(--border); border-radius: 12px; padding: 10px 20px; font-size: 0.85rem; font-weight: 600; white-space: nowrap; opacity: 0; transition: all 0.3s; pointer-events: none; }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
  .section-title { font-size: 0.85rem; font-weight: 700; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; }

  .type-toggle { display: flex; gap: 8px; margin-bottom: 16px; }
  .type-btn { flex: 1; padding: 10px; border-radius: 10px; border: 1.5px solid var(--border); background: transparent; font-family: var(--font); font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; color: var(--text2); }
  .type-btn.expense.active { background: rgba(248,113,113,0.15); border-color: var(--red); color: var(--red); }
  .type-btn.income.active { background: rgba(74,222,128,0.15); border-color: var(--green); color: var(--green); }

  .empty-state { text-align: center; padding: 40px 20px; color: var(--text3); }
  .empty-state .emoji { font-size: 3rem; margin-bottom: 12px; }
  .empty-state p { font-size: 0.9rem; }

  .divider { height: 1px; background: var(--border); margin: 12px 0; }
  
  .credit-card-preview {
    background: linear-gradient(135deg, var(--bg4), var(--bg3));
    border: 1px solid var(--border); border-radius: 16px; padding: 18px;
    position: relative; overflow: hidden; margin-bottom: 10px;
  }
  .credit-card-preview::before {
    content: ''; position: absolute; top: -30px; right: -30px;
    width: 120px; height: 120px; border-radius: 50%;
    background: rgba(255,255,255,0.03);
  }
  .card-type-badge { font-size: 0.7rem; font-weight: 700; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; }
  .card-name { font-family: var(--mono); font-size: 1rem; font-weight: 700; margin: 8px 0 4px; }
  .card-limit-bar { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; margin-top: 10px; }
  .card-limit-fill { height: 100%; background: var(--accent3); border-radius: 2px; }

  .page { display: none; }
  .page.active { display: block; }
</style>
</head>
<body>
<div id="app">
  <div class="topbar">
    <div class="topbar-title">üí∏ Money Log</div>
    <div class="topbar-actions" id="topbar-actions"></div>
  </div>
  
  <div class="main-content">
    <!-- Dashboard Page -->
    <div id="page-dashboard" class="page active">
      <div class="tabs" id="period-tabs">
        <button class="tab active" onclick="setPeriod('day')">Day</button>
        <button class="tab" onclick="setPeriod('month')">Month</button>
        <button class="tab" onclick="setPeriod('year')">Year</button>
      </div>
      
      <div class="card" style="margin-bottom:12px">
        <div id="period-selector"></div>
      </div>
      
      <div class="summary-grid" id="summary-grid"></div>
      
      <div class="card" style="margin-bottom:12px">
        <div class="card-title">‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</div>
        <div id="payment-breakdown"></div>
        <div class="chart-wrap pie">
          <canvas id="pie-chart"></canvas>
        </div>
      </div>
      
      <div class="card" style="margin-bottom:12px">
        <div class="card-title">‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° Category</div>
        <div id="category-breakdown"></div>
        <div class="chart-wrap">
          <canvas id="bar-chart"></canvas>
        </div>
      </div>
    </div>
    
    <!-- Transactions Page -->
    <div id="page-transactions" class="page">
      <div class="section-header">
        <div class="section-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        <button class="btn btn-sm" onclick="showFilterModal()">üîç ‡∏Å‡∏£‡∏≠‡∏á</button>
      </div>
      <div id="tx-list"></div>
    </div>
    
    <!-- Settings Page -->
    <div id="page-settings" class="page">
      <div class="card">
        <div class="card-title">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
        <div class="settings-item" onclick="showCategorySettings()">
          <div class="settings-item-left">
            <div class="settings-item-icon" style="background:rgba(110,231,183,0.1)">üè∑Ô∏è</div>
            <div>
              <div class="settings-item-title">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div>
              <div class="settings-item-sub" id="cat-count">0 ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div>
            </div>
          </div>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        </div>
        <div class="settings-item" onclick="showCardSettings()">
          <div class="settings-item-left">
            <div class="settings-item-icon" style="background:rgba(244,114,182,0.1)">üí≥</div>
            <div>
              <div class="settings-item-title">‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</div>
              <div class="settings-item-sub" id="card-count">0 ‡πÉ‡∏ö</div>
            </div>
          </div>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        </div>
        <div class="settings-item" onclick="exportData()">
          <div class="settings-item-left">
            <div class="settings-item-icon" style="background:rgba(56,189,248,0.1)">üì§</div>
            <div>
              <div class="settings-item-title">Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
              <div class="settings-item-sub">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô JSON</div>
            </div>
          </div>
        </div>
        <div class="settings-item" onclick="importData()">
          <div class="settings-item-left">
            <div class="settings-item-icon" style="background:rgba(251,191,36,0.1)">üì•</div>
            <div>
              <div class="settings-item-title">Import ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
              <div class="settings-item-sub">‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å JSON</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card" style="margin-top:12px">
        <div class="card-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏≠‡∏õ</div>
        <div class="settings-item" style="cursor:default">
          <div class="settings-item-left">
            <div class="settings-item-icon" style="background:rgba(167,139,250,0.1)">‚ÑπÔ∏è</div>
            <div>
              <div class="settings-item-title">Money Log v1.0</div>
              <div class="settings-item-sub">PWA ¬∑ IndexedDB ¬∑ Works Offline</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <nav class="bottom-nav">
    <button class="nav-item active" onclick="showPage('dashboard')" id="nav-dashboard">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      Dashboard
    </button>
    <button class="nav-item" onclick="showPage('transactions')" id="nav-transactions">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
      ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    </button>
    <button class="nav-item" onclick="showPage('settings')" id="nav-settings">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
      ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
    </button>
  </nav>
  
  <button class="btn-fab" id="fab" onclick="showAddModal()">+</button>
</div>

<!-- Add Transaction Modal -->
<div class="modal-overlay" id="modal-add">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
    <div class="type-toggle">
      <button class="type-btn expense active" id="type-expense" onclick="setType('expense')">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
      <button class="type-btn income" id="type-income" onclick="setType('income')">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
    </div>
    <div class="form-group">
      <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
      <input type="number" class="form-input amount-input" id="tx-amount" placeholder="0.00" inputmode="decimal">
    </div>
    <div class="form-group">
      <label class="form-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
      <input type="text" class="form-input" id="tx-note" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...">
    </div>
    <div class="form-group">
      <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
      <div class="chips" id="category-chips"></div>
    </div>
    <div class="form-group">
      <label class="form-label">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
      <select class="form-input" id="tx-payment">
        <option value="cash">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
        <option value="bank">üè¶ Mobile Bank</option>
        <option value="credit">üí≥ ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</option>
      </select>
    </div>
    <div class="form-group" id="credit-card-select-group" style="display:none">
      <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏±‡∏ï‡∏£</label>
      <select class="form-input" id="tx-card-id"></select>
    </div>
    <div class="form-group" style="width: 100%;">
      <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
      <input type="date" class="form-input" style="width: 80%;" id="tx-date">
    </div>
    <div class="modal-footer">
      <button class="btn btn-sm" onclick="closeModal('modal-add')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-primary" onclick="saveTransaction()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- Category Settings Modal -->
<div class="modal-overlay" id="modal-categories">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="section-header">
      <div class="modal-title" style="margin-bottom:0">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div>
      <button class="btn btn-sm" onclick="showAddCategoryModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
    </div>
    <div id="category-list" style="margin-top:12px"></div>
    <div style="margin-top:12px">
      <button class="btn btn-sm" style="width:100%" onclick="closeModal('modal-categories')">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>
</div>

<!-- Add Category Modal -->
<div class="modal-overlay" id="modal-add-category">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="cat-modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div>
    <div class="form-group">
      <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
      <input type="text" class="form-input" id="cat-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏≤‡∏´‡∏≤‡∏£, ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á...">
    </div>
    <div class="form-group">
      <label class="form-label">Emoji</label>
      <div class="emoji-grid" id="emoji-picker"></div>
    </div>
    <div class="form-group">
      <label class="form-label">‡∏™‡∏µ</label>
      <div class="color-grid" id="color-picker"></div>
    </div>
    <input type="hidden" id="cat-id">
    <div class="modal-footer">
      <button class="btn btn-sm" onclick="closeModal('modal-add-category')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-primary" onclick="saveCategory()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- Card Settings Modal -->
<div class="modal-overlay" id="modal-cards">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="section-header">
      <div class="modal-title" style="margin-bottom:0">‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</div>
      <button class="btn btn-sm" onclick="showAddCardModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
    </div>
    <div id="card-list" style="margin-top:12px"></div>
    <div style="margin-top:12px">
      <button class="btn btn-sm" style="width:100%" onclick="closeModal('modal-cards')">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>
</div>

<!-- Add Card Modal -->
<div class="modal-overlay" id="modal-add-card">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="card-modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</div>
    <div class="form-group">
      <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ï‡∏£</label>
      <input type="text" class="form-input" id="card-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô KBank Mastercard">
    </div>
    <div class="form-group">
      <label class="form-label">‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
      <input type="number" class="form-input" id="card-limit" placeholder="50000">
    </div>
    <div class="form-group">
      <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ï‡∏£</label>
      <select class="form-input" id="card-type" onchange="toggleSupplementaryFields()">
        <option value="main">‡∏ö‡∏±‡∏ï‡∏£‡∏´‡∏•‡∏±‡∏Å</option>
        <option value="supplementary">‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°</option>
      </select>
    </div>
    <div id="main-card-select-group" style="display:none">
      <div class="form-group">
        <label class="form-label">‡∏ö‡∏±‡∏ï‡∏£‡∏´‡∏•‡∏±‡∏Å</label>
        <select class="form-input" id="card-main-id"></select>
      </div>
    </div>
    <input type="hidden" id="card-id">
    <div class="modal-footer">
      <button class="btn btn-sm" onclick="closeModal('modal-add-card')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-primary" onclick="saveCard()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- Transaction Detail Modal -->
<div class="modal-overlay" id="modal-tx-detail">
  <div class="modal">
    <div class="modal-handle"></div>
    <div id="tx-detail-content"></div>
    <div class="modal-footer">
      <button class="btn btn-sm btn-danger" id="btn-delete-tx" onclick="deleteCurrentTx()">üóë ‡∏•‡∏ö</button>
      <button class="btn btn-sm" style="flex:2" onclick="closeModal('modal-tx-detail')">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>
</div>

<!-- Filter Modal -->
<div class="modal-overlay" id="modal-filter">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
    <div class="form-group">
      <label class="form-label">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
      <input type="date" class="form-input" id="filter-from">
    </div>
    <div class="form-group">
      <label class="form-label">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
      <input type="date" class="form-input" id="filter-to">
    </div>
    <div class="form-group">
      <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
      <select class="form-input" id="filter-type">
        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
        <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</label>
      <select class="form-input" id="filter-payment">
        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option value="cash">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
        <option value="bank">Mobile Bank</option>
        <option value="credit">‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</option>
      </select>
    </div>
    <div class="modal-footer">
      <button class="btn btn-sm" onclick="clearFilter()">‡∏•‡πâ‡∏≤‡∏á</button>
      <button class="btn btn-primary" onclick="applyFilter()">‡∏Å‡∏£‡∏≠‡∏á</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============ DATABASE ============
let db;
const DB_NAME = 'MoneyLogDB', DB_VER = 1;

function openDB() {
  return new Promise((res, rej) => {
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = e => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains('transactions')) {
        const s = d.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
        s.createIndex('date', 'date');
      }
      if (!d.objectStoreNames.contains('categories')) {
        d.createObjectStore('categories', { keyPath: 'id', autoIncrement: true });
      }
      if (!d.objectStoreNames.contains('cards')) {
        d.createObjectStore('cards', { keyPath: 'id', autoIncrement: true });
      }
    };
    req.onsuccess = e => { db = e.target.result; res(db); };
    req.onerror = e => rej(e);
  });
}

function dbGetAll(store) {
  return new Promise((res, rej) => {
    const tx = db.transaction(store, 'readonly');
    const req = tx.objectStore(store).getAll();
    req.onsuccess = () => res(req.result);
    req.onerror = () => rej(req.error);
  });
}

function dbAdd(store, data) {
  return new Promise((res, rej) => {
    const tx = db.transaction(store, 'readwrite');
    const req = tx.objectStore(store).add(data);
    req.onsuccess = () => res(req.result);
    req.onerror = () => rej(req.error);
  });
}

function dbPut(store, data) {
  return new Promise((res, rej) => {
    const tx = db.transaction(store, 'readwrite');
    const req = tx.objectStore(store).put(data);
    req.onsuccess = () => res(req.result);
    req.onerror = () => rej(req.error);
  });
}

function dbDelete(store, id) {
  return new Promise((res, rej) => {
    const tx = db.transaction(store, 'readwrite');
    const req = tx.objectStore(store).delete(id);
    req.onsuccess = () => res();
    req.onerror = () => rej(req.error);
  });
}

function dbClear(store) {
  return new Promise((res, rej) => {
    const tx = db.transaction(store, 'readwrite');
    const req = tx.objectStore(store).clear();
    req.onsuccess = () => res();
    req.onerror = () => rej(req.error);
  });
}

// ============ STATE ============
let currentPage = 'dashboard';
let currentPeriod = 'day';
let selectedDate = new Date();
let selectedMonth = new Date();
let selectedYear = new Date();
let selectedType = 'expense';
let selectedCategory = null;
let selectedEmoji = 'üõç';
let selectedColor = '#6ee7b7';
let currentTxId = null;
let filterState = {};
let pieChartInstance = null;
let barChartInstance = null;

const EMOJIS = ['üõç','üçî','üöó','üè†','üíä','üéÆ','‚úàÔ∏è','üëó','üéì','üíº','üõí','‚òï','üçï','üçú','üéµ','üì±','üíª','üé¨','üèãÔ∏è','üêæ','üåø','üéÅ','üí°','üöø','üç∫','üí∞','üí∏','üìö','üîë','üéØ','üè•','‚õΩ','üåÆ','üç∞','üíà','üé™','üõ¥','üöå','üèä','üé®'];
const COLORS = ['#6ee7b7','#38bdf8','#f472b6','#fb923c','#a78bfa','#fbbf24','#4ade80','#f87171','#e879f9','#22d3ee','#84cc16','#f97316','#818cf8','#f43f5e','#10b981','#0ea5e9'];

const DEFAULT_CATEGORIES = [
  { name: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£', emoji: 'üçî', color: '#fb923c' },
  { name: '‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á', emoji: 'üöó', color: '#38bdf8' },
  { name: '‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å', emoji: 'üè†', color: '#a78bfa' },
  { name: '‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û', emoji: 'üíä', color: '#4ade80' },
  { name: '‡∏ä‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á', emoji: 'üõç', color: '#f472b6' },
  { name: '‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á', emoji: 'üéÆ', color: '#fbbf24' },
  { name: '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö', emoji: 'üí∞', color: '#6ee7b7' },
];

// ============ UTILS ============
function formatMoney(n) {
  return new Intl.NumberFormat('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n);
}

function formatDate(d) {
  return new Date(d).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
}

function toYMD(d) {
  const dt = new Date(d);
  return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

function openModal(id) {
  document.getElementById(id).classList.add('open');
  document.body.classList.add('no-scroll');
}

function closeModal(id) {
  const el = document.getElementById(id);
  if (el) el.classList.remove('open');
  // Remove no-scroll only when no other modal is open
  const anyOpen = document.querySelector('.modal-overlay.open');
  if (!anyOpen) {
    document.body.classList.remove('no-scroll');
  }
}

// ============ NAVIGATION ============
function showPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById(`page-${page}`).classList.add('active');
  document.getElementById(`nav-${page}`).classList.add('active');
  currentPage = page;
  
  const fab = document.getElementById('fab');
  fab.style.display = page === 'settings' ? 'none' : 'flex';
  
  if (page === 'dashboard') renderDashboard();
  if (page === 'transactions') renderTransactions();
  if (page === 'settings') renderSettingsInfo();
}

// ============ PERIOD ============
function setPeriod(p) {
  currentPeriod = p;
  document.querySelectorAll('#period-tabs .tab').forEach((t, i) => {
    t.classList.toggle('active', ['day','month','year'][i] === p);
  });
  renderPeriodSelector();
  renderDashboard();
}

function renderPeriodSelector() {
  const el = document.getElementById('period-selector');
  if (currentPeriod === 'day') {
    el.innerHTML = `<div class="date-nav"><label style="font-size:.8rem;color:var(--text2);font-weight:600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô</label><input type="date" id="sel-date" value="${toYMD(selectedDate)}" onchange="selectedDate=new Date(this.value+'T12:00:00');renderDashboard()"></div>`;
  } else if (currentPeriod === 'month') {
    const v = `${selectedMonth.getFullYear()}-${String(selectedMonth.getMonth()+1).padStart(2,'0')}`;
    el.innerHTML = `<div class="date-nav"><label style="font-size:.8rem;color:var(--text2);font-weight:600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label><input type="month" id="sel-month" value="${v}" onchange="selectedMonth=new Date(this.value+'-01T12:00:00');renderDashboard()"></div>`;
  } else {
    el.innerHTML = `<div class="date-nav"><label style="font-size:.8rem;color:var(--text2);font-weight:600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ</label><input type="number" id="sel-year" value="${selectedYear.getFullYear()}" min="2000" max="2099" style="width:120px" class="form-input" onchange="selectedYear.setFullYear(parseInt(this.value));renderDashboard()"></div>`;
  }
}

function getPeriodRange() {
  if (currentPeriod === 'day') {
    const d = toYMD(selectedDate);
    return { from: d, to: d };
  } else if (currentPeriod === 'month') {
    const y = selectedMonth.getFullYear(), m = selectedMonth.getMonth();
    const from = `${y}-${String(m+1).padStart(2,'0')}-01`;
    const last = new Date(y, m+1, 0);
    const to = toYMD(last);
    return { from, to };
  } else {
    const y = selectedYear.getFullYear();
    return { from: `${y}-01-01`, to: `${y}-12-31` };
  }
}

// ============ DASHBOARD ============
async function renderDashboard() {
  renderPeriodSelector();
  const { from, to } = getPeriodRange();
  const all = await dbGetAll('transactions');
  const txs = all.filter(t => t.date >= from && t.date <= to);
  const cats = await dbGetAll('categories');
  const cards = await dbGetAll('cards');
  
  const expenses = txs.filter(t => t.type === 'expense');
  const incomes = txs.filter(t => t.type === 'income');
  const totalExp = expenses.reduce((s, t) => s + t.amount, 0);
  const totalInc = incomes.reduce((s, t) => s + t.amount, 0);
  
  // Summary
  const sg = document.getElementById('summary-grid');
  sg.innerHTML = `
    <div class="summary-card"><div class="summary-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</div><div class="summary-value income">‡∏ø${formatMoney(totalInc)}</div></div>
    <div class="summary-card"><div class="summary-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div><div class="summary-value expense">‡∏ø${formatMoney(totalExp)}</div></div>
    <div class="summary-card full"><div class="summary-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div><div class="summary-value neutral">‡∏ø${formatMoney(totalInc - totalExp)}</div></div>
  `;
  
  // Payment breakdown
  const cashExp = expenses.filter(t => t.payment === 'cash').reduce((s,t) => s+t.amount, 0);
  const bankExp = expenses.filter(t => t.payment === 'bank').reduce((s,t) => s+t.amount, 0);
  const creditExp = expenses.filter(t => t.payment === 'credit').reduce((s,t) => s+t.amount, 0);
  
  const pb = document.getElementById('payment-breakdown');
  pb.innerHTML = `
    <div class="method-row">
      <div class="method-left"><div class="method-icon" style="background:rgba(251,191,36,.1)">üíµ</div><div><div class="method-name">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</div></div></div>
      <div class="method-amount" style="color:var(--yellow)">‡∏ø${formatMoney(cashExp)}</div>
    </div>
    <div class="method-row">
      <div class="method-left"><div class="method-icon" style="background:rgba(56,189,248,.1)">üè¶</div><div><div class="method-name">Mobile Bank</div></div></div>
      <div class="method-amount" style="color:var(--accent2)">‡∏ø${formatMoney(bankExp)}</div>
    </div>
    <div class="method-row">
      <div class="method-left"><div class="method-icon" style="background:rgba(244,114,182,.1)">üí≥</div><div><div class="method-name">‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</div></div></div>
      <div class="method-amount" style="color:var(--accent3)">‡∏ø${formatMoney(creditExp)}</div>
    </div>
    <div class="divider"></div>
    <div class="method-row" style="padding:6px 0">
      <div class="method-left"><div style="font-weight:700;font-size:.9rem">‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div></div>
      <div class="method-amount" style="color:var(--red)">‡∏ø${formatMoney(totalExp)}</div>
    </div>
  `;
  
  // Pie chart
  if (pieChartInstance) pieChartInstance.destroy();
  const pieCtx = document.getElementById('pie-chart').getContext('2d');
  const pieData = [cashExp, bankExp, creditExp].filter(v => v > 0);
  const pieLabels = ['‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î','Mobile Bank','‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï'].filter((_, i) => [cashExp,bankExp,creditExp][i] > 0);
  const pieColors = ['#fbbf24','#38bdf8','#f472b6'].filter((_, i) => [cashExp,bankExp,creditExp][i] > 0);
  
  if (pieData.length > 0) {
    pieChartInstance = new Chart(pieCtx, {
      type: 'doughnut',
      data: { labels: pieLabels, datasets: [{ data: pieData, backgroundColor: pieColors, borderWidth: 0, hoverOffset: 8 }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', labels: { color: '#8892b0', font: { family: 'Sarabun', size: 12 }, padding: 12, boxWidth: 12 } },
          tooltip: { callbacks: { label: ctx => ` ‡∏ø${formatMoney(ctx.parsed)}` } }
        },
        cutout: '65%'
      }
    });
  }
  
  // Category breakdown
  const catMap = {};
  expenses.forEach(t => {
    if (!catMap[t.categoryId]) catMap[t.categoryId] = 0;
    catMap[t.categoryId] += t.amount;
  });
  
  const catBreakdown = Object.entries(catMap)
    .map(([id, amount]) => {
      const cat = cats.find(c => c.id == id) || { name: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ', emoji: 'üì¶', color: '#8892b0' };
      return { cat, amount };
    })
    .sort((a, b) => b.amount - a.amount);
  
  const cb = document.getElementById('category-breakdown');
  if (catBreakdown.length === 0) {
    cb.innerHTML = '<div style="color:var(--text3);font-size:.85rem;padding:8px 0">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
  } else {
    const maxAmt = catBreakdown[0].amount;
    cb.innerHTML = catBreakdown.map(({ cat, amount }) => `
      <div class="cat-row">
        <span style="font-size:1.1rem">${cat.emoji}</span>
        <div class="cat-bar-wrap">
          <div class="cat-bar-label">
            <span style="font-weight:600;font-size:.82rem">${cat.name}</span>
            <span style="font-family:var(--mono);font-size:.8rem;color:var(--red)">‡∏ø${formatMoney(amount)}</span>
          </div>
          <div class="cat-bar"><div class="cat-bar-fill" style="width:${(amount/maxAmt*100).toFixed(1)}%;background:${cat.color}"></div></div>
        </div>
      </div>
    `).join('');
  }
  
  // Bar chart
  if (barChartInstance) barChartInstance.destroy();
  const barCtx = document.getElementById('bar-chart').getContext('2d');
  if (catBreakdown.length > 0) {
    barChartInstance = new Chart(barCtx, {
      type: 'bar',
      data: {
        labels: catBreakdown.map(({ cat }) => cat.emoji + ' ' + cat.name),
        datasets: [{
          data: catBreakdown.map(({ amount }) => amount),
          backgroundColor: catBreakdown.map(({ cat }) => cat.color + 'cc'),
          borderColor: catBreakdown.map(({ cat }) => cat.color),
          borderWidth: 1, borderRadius: 6
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => ` ‡∏ø${formatMoney(ctx.parsed.y)}` } } },
        scales: {
          x: { ticks: { color: '#8892b0', font: { family: 'Sarabun', size: 11 } }, grid: { color: '#2a3050' } },
          y: { ticks: { color: '#8892b0', font: { family: 'Sarabun', size: 11 }, callback: v => '‡∏ø' + formatMoney(v) }, grid: { color: '#2a3050' } }
        }
      }
    });
  }
}

// ============ TRANSACTIONS ============
async function renderTransactions() {
  const all = await dbGetAll('transactions');
  const cats = await dbGetAll('categories');
  const cards = await dbGetAll('cards');
  
  let txs = [...all].sort((a, b) => b.date.localeCompare(a.date) || b.id - a.id);
  
  if (filterState.from) txs = txs.filter(t => t.date >= filterState.from);
  if (filterState.to) txs = txs.filter(t => t.date <= filterState.to);
  if (filterState.type) txs = txs.filter(t => t.type === filterState.type);
  if (filterState.payment) txs = txs.filter(t => t.payment === filterState.payment);
  
  const el = document.getElementById('tx-list');
  
  if (txs.length === 0) {
    el.innerHTML = `<div class="empty-state"><div class="emoji">üì≠</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>‡∏Å‡∏î + ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p></div>`;
    return;
  }
  
  // Group by date
  const groups = {};
  txs.forEach(t => {
    if (!groups[t.date]) groups[t.date] = [];
    groups[t.date].push(t);
  });
  
  el.innerHTML = Object.entries(groups).sort((a,b) => b[0].localeCompare(a[0])).map(([date, items]) => {
    const dayTotal = items.reduce((s, t) => t.type === 'expense' ? s - t.amount : s + t.amount, 0);
    const itemsHtml = items.map(t => {
      const cat = cats.find(c => c.id === t.categoryId) || { name: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ', emoji: 'üì¶', color: '#8892b0' };
      const payIcon = t.payment === 'cash' ? 'üíµ' : t.payment === 'bank' ? 'üè¶' : 'üí≥';
      const card = t.cardId ? cards.find(c => c.id === t.cardId) : null;
      const payLabel = t.payment === 'credit' && card ? card.name : t.payment === 'cash' ? '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' : 'Mobile Bank';
      return `
        <div class="tx-item" onclick="showTxDetail(${t.id})" style="cursor:pointer">
          <div class="tx-icon" style="background:${cat.color}22">${cat.emoji}</div>
          <div class="tx-info">
            <div class="tx-name">${t.note || cat.name}</div>
            <div class="tx-meta">${cat.name} ¬∑ ${payIcon} ${payLabel}</div>
          </div>
          <div class="tx-amount ${t.type}">${t.type === 'expense' ? '-' : '+'}‡∏ø${formatMoney(t.amount)}</div>
        </div>
      `;
    }).join('');
    
    return `
      <div class="card" style="margin-bottom:10px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-size:.8rem;font-weight:700;color:var(--text2)">${formatDate(date + 'T12:00:00')}</div>
          <div style="font-family:var(--mono);font-size:.8rem;color:${dayTotal >= 0 ? 'var(--green)' : 'var(--red)'};font-weight:700">${dayTotal >= 0 ? '+' : ''}‡∏ø${formatMoney(Math.abs(dayTotal))}</div>
        </div>
        ${itemsHtml}
      </div>
    `;
  }).join('');
}

async function showTxDetail(id) {
  const all = await dbGetAll('transactions');
  const t = all.find(tx => tx.id === id);
  if (!t) return;
  currentTxId = id;
  
  const cats = await dbGetAll('categories');
  const cards = await dbGetAll('cards');
  const cat = cats.find(c => c.id === t.categoryId) || { name: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ', emoji: 'üì¶', color: '#8892b0' };
  const card = t.cardId ? cards.find(c => c.id === t.cardId) : null;
  
  const payNames = { cash: 'üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î', bank: 'üè¶ Mobile Bank', credit: 'üí≥ ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï' };
  
  document.getElementById('tx-detail-content').innerHTML = `
    <div style="text-align:center;padding:20px 0">
      <div style="font-size:3rem;margin-bottom:8px">${cat.emoji}</div>
      <div style="font-family:var(--mono);font-size:2rem;font-weight:700;color:${t.type === 'expense' ? 'var(--red)' : 'var(--green)'}">${t.type === 'expense' ? '-' : '+'}‡∏ø${formatMoney(t.amount)}</div>
      <div style="color:var(--text2);margin-top:4px">${t.note || cat.name}</div>
    </div>
    <div class="divider"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:8px 0">
      <div><div class="summary-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div><div style="font-weight:600;margin-top:4px">${cat.name}</div></div>
      <div><div class="summary-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div><div style="font-weight:600;margin-top:4px">${formatDate(t.date + 'T12:00:00')}</div></div>
      <div><div class="summary-label">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</div><div style="font-weight:600;margin-top:4px">${payNames[t.payment]}</div></div>
      ${card ? `<div><div class="summary-label">‡∏ö‡∏±‡∏ï‡∏£</div><div style="font-weight:600;margin-top:4px">${card.name}</div></div>` : ''}
    </div>
  `;
  openModal('modal-tx-detail');
}

async function deleteCurrentTx() {
  if (!currentTxId) return;
  await dbDelete('transactions', currentTxId);
  closeModal('modal-tx-detail');
  showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß');
  renderTransactions();
  if (currentPage === 'dashboard') renderDashboard();
}

// ============ ADD TRANSACTION ============
function showAddModal() {
  selectedType = 'expense';
  selectedCategory = null;
  document.getElementById('tx-amount').value = '';
  document.getElementById('tx-note').value = '';
  document.getElementById('tx-date').value = toYMD(new Date());
  document.getElementById('tx-payment').value = 'cash';
  document.getElementById('credit-card-select-group').style.display = 'none';
  renderCategoryChips();
  document.getElementById('type-expense').classList.add('active');
  document.getElementById('type-income').classList.remove('active');
  openModal('modal-add');
}

function setType(t) {
  selectedType = t;
  document.getElementById('type-expense').classList.toggle('active', t === 'expense');
  document.getElementById('type-income').classList.toggle('active', t === 'income');
  renderCategoryChips();
}

async function renderCategoryChips() {
  const cats = await dbGetAll('categories');
  const el = document.getElementById('category-chips');
  if (cats.length === 0) {
    el.innerHTML = '<div style="color:var(--text3);font-size:.8rem">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>';
    return;
  }
  el.innerHTML = cats.map(c => `
    <button class="chip ${selectedCategory === c.id ? 'selected' : ''}" onclick="selectCategory(${c.id})">${c.emoji} ${c.name}</button>
  `).join('');
}

function selectCategory(id) {
  selectedCategory = selectedCategory === id ? null : id;
  renderCategoryChips();
}

document.getElementById('tx-payment').addEventListener('change', async function() {
  const group = document.getElementById('credit-card-select-group');
  if (this.value === 'credit') {
    const cards = await dbGetAll('cards');
    const sel = document.getElementById('tx-card-id');
    sel.innerHTML = cards.map(c => `<option value="${c.id}">${c.name}${c.type === 'supplementary' ? ' (‡πÄ‡∏™‡∏£‡∏¥‡∏°)' : ''}</option>`).join('');
    group.style.display = cards.length ? 'block' : 'none';
  } else {
    group.style.display = 'none';
  }
});

async function saveTransaction() {
  const amount = parseFloat(document.getElementById('tx-amount').value);
  if (!amount || amount <= 0) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô'); return; }
  if (!selectedCategory) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'); return; }
  
  const payment = document.getElementById('tx-payment').value;
  const cardId = payment === 'credit' ? parseInt(document.getElementById('tx-card-id').value) || null : null;
  
  const tx = {
    amount,
    type: selectedType,
    note: document.getElementById('tx-note').value.trim(),
    categoryId: selectedCategory,
    payment,
    cardId,
    date: document.getElementById('tx-date').value,
    createdAt: new Date().toISOString()
  };
  
  await dbAdd('transactions', tx);
  closeModal('modal-add');
  showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úì');
  
  if (currentPage === 'dashboard') renderDashboard();
  if (currentPage === 'transactions') renderTransactions();
}

// ============ CATEGORIES ============
async function showCategorySettings() {
  await renderCategoryList();
  openModal('modal-categories');
}

async function renderCategoryList() {
  const cats = await dbGetAll('categories');
  const el = document.getElementById('category-list');
  if (cats.length === 0) {
    el.innerHTML = '<div class="empty-state"><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</p></div>';
    return;
  }
  el.innerHTML = cats.map(c => `
    <div class="tx-item">
      <div class="tx-icon" style="background:${c.color}22;font-size:1.3rem">${c.emoji}</div>
      <div class="tx-info"><div class="tx-name">${c.name}</div></div>
      <div style="display:flex;gap:6px">
        <button class="btn btn-sm" onclick="editCategory(${c.id})">‚úèÔ∏è</button>
        <button class="btn btn-sm btn-danger" onclick="deleteCategory(${c.id})">üóë</button>
      </div>
    </div>
  `).join('');
}

function showAddCategoryModal(editId) {
  document.getElementById('cat-name').value = '';
  document.getElementById('cat-id').value = editId || '';
  document.getElementById('cat-modal-title').textContent = editId ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà';
  selectedEmoji = 'üõç';
  selectedColor = '#6ee7b7';
  renderEmojiPicker();
  renderColorPicker();
  openModal('modal-add-category');
}

async function editCategory(id) {
  const cats = await dbGetAll('categories');
  const cat = cats.find(c => c.id === id);
  if (!cat) return;
  document.getElementById('cat-name').value = cat.name;
  document.getElementById('cat-id').value = id;
  document.getElementById('cat-modal-title').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà';
  selectedEmoji = cat.emoji;
  selectedColor = cat.color;
  renderEmojiPicker();
  renderColorPicker();
  openModal('modal-add-category');
}

async function deleteCategory(id) {
  await dbDelete('categories', id);
  showToast('‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
  renderCategoryList();
  renderSettingsInfo();
}

async function saveCategory() {
  const name = document.getElementById('cat-name').value.trim();
  if (!name) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'); return; }
  const editId = document.getElementById('cat-id').value;
  const cat = { name, emoji: selectedEmoji, color: selectedColor };
  
  if (editId) {
    await dbPut('categories', { ...cat, id: parseInt(editId) });
  } else {
    await dbAdd('categories', cat);
  }
  
  closeModal('modal-add-category');
  showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‚úì');
  renderCategoryList();
  renderSettingsInfo();
}

function renderEmojiPicker() {
  document.getElementById('emoji-picker').innerHTML = EMOJIS.map(e => `
    <button class="emoji-btn ${selectedEmoji === e ? 'selected' : ''}" onclick="selectedEmoji='${e}';renderEmojiPicker()">${e}</button>
  `).join('');
}

function renderColorPicker() {
  document.getElementById('color-picker').innerHTML = COLORS.map(c => `
    <div class="color-swatch ${selectedColor === c ? 'selected' : ''}" style="background:${c}" onclick="selectedColor='${c}';renderColorPicker()"></div>
  `).join('');
}

// ============ CREDIT CARDS ============
async function showCardSettings() {
  await renderCardList();
  openModal('modal-cards');
}

async function renderCardList() {
  const cards = await dbGetAll('cards');
  const el = document.getElementById('card-list');
  if (cards.length === 0) {
    el.innerHTML = '<div class="empty-state"><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</p></div>';
    return;
  }
  
  // Calculate usage per main card
  const all = await dbGetAll('transactions');
  const now = new Date();
  const monthFrom = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-01`;
  const lastDay = new Date(now.getFullYear(), now.getMonth()+1, 0);
  const monthTo = toYMD(lastDay);
  const monthTx = all.filter(t => t.date >= monthFrom && t.date <= monthTo && t.type === 'expense' && t.payment === 'credit');
  
  // Group cards
  const mainCards = cards.filter(c => c.type === 'main');
  const suppCards = cards.filter(c => c.type === 'supplementary');
  
  el.innerHTML = mainCards.map(mc => {
    const relatedCards = [mc, ...suppCards.filter(s => s.mainCardId === mc.id)];
    const usage = monthTx.filter(t => relatedCards.some(c => c.id === t.cardId)).reduce((s, t) => s + t.amount, 0);
    const pct = mc.limit > 0 ? Math.min((usage / mc.limit * 100), 100) : 0;
    
    const suppHtml = suppCards.filter(s => s.mainCardId === mc.id).map(s => `
      <div style="padding:6px 0 0 12px;border-left:2px solid var(--border);margin-top:6px;margin-left:6px">
        <div style="font-size:.8rem;color:var(--text2);font-weight:600">üîó ${s.name} <span style="font-size:.7rem">(‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°)</span></div>
      </div>
    `).join('');
    
    return `
      <div class="credit-card-preview">
        <div style="display:flex;justify-content:space-between;align-items:start">
          <div>
            <div class="card-type-badge">‡∏ö‡∏±‡∏ï‡∏£‡∏´‡∏•‡∏±‡∏Å</div>
            <div class="card-name">üí≥ ${mc.name}</div>
            <div style="font-size:.75rem;color:var(--text2)">‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô ‡∏ø${formatMoney(mc.limit)} ¬∑ ‡πÉ‡∏ä‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ‡∏ø${formatMoney(usage)}</div>
          </div>
          <div style="display:flex;gap:6px">
            <button class="btn btn-sm" onclick="editCard(${mc.id})">‚úèÔ∏è</button>
            <button class="btn btn-sm btn-danger" onclick="deleteCard(${mc.id})">üóë</button>
          </div>
        </div>
        <div class="card-limit-bar"><div class="card-limit-fill" style="width:${pct}%"></div></div>
        ${suppHtml}
      </div>
    `;
  }).join('') + suppCards.filter(s => !mainCards.find(m => m.id === s.mainCardId)).map(s => `
    <div class="credit-card-preview">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><div class="card-type-badge" style="color:var(--accent3)">‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°</div><div class="card-name">üí≥ ${s.name}</div></div>
        <div style="display:flex;gap:6px">
          <button class="btn btn-sm" onclick="editCard(${s.id})">‚úèÔ∏è</button>
          <button class="btn btn-sm btn-danger" onclick="deleteCard(${s.id})">üóë</button>
        </div>
      </div>
    </div>
  `).join('');
}

async function showAddCardModal() {
  document.getElementById('card-name').value = '';
  document.getElementById('card-limit').value = '';
  document.getElementById('card-type').value = 'main';
  document.getElementById('card-id').value = '';
  document.getElementById('card-modal-title').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï';
  document.getElementById('main-card-select-group').style.display = 'none';
  await loadMainCardsSelect();
  openModal('modal-add-card');
}

async function editCard(id) {
  const cards = await dbGetAll('cards');
  const card = cards.find(c => c.id === id);
  if (!card) return;
  document.getElementById('card-name').value = card.name;
  document.getElementById('card-limit').value = card.limit || '';
  document.getElementById('card-type').value = card.type;
  document.getElementById('card-id').value = id;
  document.getElementById('card-modal-title').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï';
  await loadMainCardsSelect();
  if (card.type === 'supplementary') {
    document.getElementById('main-card-select-group').style.display = 'block';
    document.getElementById('card-main-id').value = card.mainCardId;
  }
  openModal('modal-add-card');
}

async function loadMainCardsSelect() {
  const cards = await dbGetAll('cards');
  const mainCards = cards.filter(c => c.type === 'main');
  document.getElementById('card-main-id').innerHTML = mainCards.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
}

function toggleSupplementaryFields() {
  const isSup = document.getElementById('card-type').value === 'supplementary';
  document.getElementById('main-card-select-group').style.display = isSup ? 'block' : 'none';
  document.getElementById('card-limit').closest('.form-group').style.display = isSup ? 'none' : 'block';
}

async function saveCard() {
  const name = document.getElementById('card-name').value.trim();
  if (!name) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ï‡∏£'); return; }
  
  const type = document.getElementById('card-type').value;
  const limit = type === 'main' ? (parseFloat(document.getElementById('card-limit').value) || 0) : 0;
  const mainCardId = type === 'supplementary' ? (parseInt(document.getElementById('card-main-id').value) || null) : null;
  const editId = document.getElementById('card-id').value;
  
  const card = { name, type, limit, mainCardId };
  if (editId) {
    await dbPut('cards', { ...card, id: parseInt(editId) });
  } else {
    await dbAdd('cards', card);
  }
  
  closeModal('modal-add-card');
  showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏±‡∏ï‡∏£‡πÅ‡∏•‡πâ‡∏ß ‚úì');
  renderCardList();
  renderSettingsInfo();
}

async function deleteCard(id) {
  await dbDelete('cards', id);
  showToast('‡∏•‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡πÅ‡∏•‡πâ‡∏ß');
  renderCardList();
  renderSettingsInfo();
}

// ============ SETTINGS ============
async function renderSettingsInfo() {
  const cats = await dbGetAll('categories');
  const cards = await dbGetAll('cards');
  document.getElementById('cat-count').textContent = `${cats.length} ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà`;
  document.getElementById('card-count').textContent = `${cards.length} ‡πÉ‡∏ö`;
}

// ============ FILTER ============
function showFilterModal() {
  document.getElementById('filter-from').value = filterState.from || '';
  document.getElementById('filter-to').value = filterState.to || '';
  document.getElementById('filter-type').value = filterState.type || '';
  document.getElementById('filter-payment').value = filterState.payment || '';
  openModal('modal-filter');
}

function applyFilter() {
  filterState = {
    from: document.getElementById('filter-from').value,
    to: document.getElementById('filter-to').value,
    type: document.getElementById('filter-type').value,
    payment: document.getElementById('filter-payment').value,
  };
  closeModal('modal-filter');
  renderTransactions();
}

function clearFilter() {
  filterState = {};
  closeModal('modal-filter');
  renderTransactions();
}

// ============ EXPORT/IMPORT ============
async function exportData() {
  const txs = await dbGetAll('transactions');
  const cats = await dbGetAll('categories');
  const cards = await dbGetAll('cards');
  const data = JSON.stringify({ transactions: txs, categories: cats, cards, exportedAt: new Date().toISOString() }, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `money-log-${toYMD(new Date())}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('Export ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úì');
}

function importData() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = async e => {
    const file = e.target.files[0];
    if (!file) return;
    const text = await file.text();
    try {
      const data = JSON.parse(text);
      if (data.categories) {
        await dbClear('categories');
        for (const c of data.categories) await dbPut('categories', c);
      }
      if (data.cards) {
        await dbClear('cards');
        for (const c of data.cards) await dbPut('cards', c);
      }
      if (data.transactions) {
        await dbClear('transactions');
        for (const t of data.transactions) await dbPut('transactions', t);
      }
      showToast(`Import ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úì (${data.transactions?.length || 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`);
      renderSettingsInfo();
      if (currentPage === 'dashboard') renderDashboard();
    } catch (err) {
      showToast('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    }
  };
  input.click();
}

// ============ PWA MANIFEST ============
function injectManifest() {
  const manifest = {
    name: 'Money Log',
    short_name: 'MoneyLog',
    description: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢',
    start_url: '.',
    display: 'standalone',
    background_color: '#0a0c12',
    theme_color: '#0a0c12',
    icons: [
      { src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='22' fill='%230a0c12'/><text y='.9em' font-size='70' x='15'>üí∏</text></svg>", sizes: '192x192', type: 'image/svg+xml' }
    ]
  };
  const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  document.getElementById('manifest-link').href = url;
}

// ============ INIT ============
async function init() {
  await openDB();
  
  // Seed default categories if empty
  const cats = await dbGetAll('categories');
  if (cats.length === 0) {
    for (const c of DEFAULT_CATEGORIES) await dbAdd('categories', c);
  }
  
  injectManifest();
  renderPeriodSelector();
  await renderDashboard();
  await renderSettingsInfo();
  
  // Register service worker
  if ('serviceWorker' in navigator) {
    const sw = `
      self.addEventListener('install', e => self.skipWaiting());
      self.addEventListener('activate', e => clients.claim());
      self.addEventListener('fetch', e => e.respondWith(caches.open('money-log-v1').then(c => c.match(e.request).then(r => r || fetch(e.request).catch(() => new Response('', {status: 503}))))));
    `;
    const blob = new Blob([sw], { type: 'application/javascript' });
    navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(() => {});
  }
}

// Close modal on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) {
      closeModal(overlay.id);
    }
  });
});

init();
</script>
</body>
</html>